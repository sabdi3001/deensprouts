let nextPageToken=null, shortsPageToken=null, currentQuery="islamic kids";
async function fetchJSON(url){ const r=await fetch(url); const t=await r.text(); let p=null; try{p=JSON.parse(t);}catch(e){} if(!r.ok){ console.error('[API ERROR]',{url,status:r.status,body:p||t}); throw new Error((p&&(p.error||JSON.stringify(p)))||t||('HTTP '+r.status)); } if(p&&p.error){ console.error('[API ERROR]',{url,status:r.status,body:p}); throw new Error(p.error + (p.detail? ' :: '+JSON.stringify(p.detail):'')); } return p||{}; }
function cardHTML(vid,title,thumb){ return `<a class="card" href="video.html?id=${vid}&type=youtube"><img src="${thumb}" alt=""><div class="title">${title}</div></a>`; }
async function loadHomeVideos(reset=false){ const host=document.getElementById('home-videos'); const btnC=document.getElementById('load-more-container'); if(reset){ host.innerHTML=''; nextPageToken=null; } try{ let url='/.netlify/functions/videos?q='+encodeURIComponent(currentQuery); if(nextPageToken) url+='&pageToken='+encodeURIComponent(nextPageToken); const data=await fetchJSON(url); const items=(data.items||[]).filter(it=>it.id&&it.id.videoId); if(reset && !items.length){ host.innerHTML='<div class="title" style="color:#a00">No videos found.</div>'; return; } for(const it of items){ const v=it.id.videoId, t=it.snippet.title, th=(it.snippet.thumbnails&&(it.snippet.thumbnails.high||it.snippet.thumbnails.medium||it.snippet.thumbnails.default)).url; host.insertAdjacentHTML('beforeend', cardHTML(v,t,th)); } nextPageToken=data.nextPageToken||null; btnC.innerHTML = nextPageToken ? '<button class="btn" id="moreBtn">Load More</button>' : ''; document.getElementById('moreBtn')?.addEventListener('click', ()=>loadHomeVideos(false)); }catch(e){ if(reset) host.innerHTML='<div class="title" style="color:#a00">Error loading videos.</div>'; console.error(e); } }
async function loadDeenShorts(reset=false){ const host=document.getElementById('shorts-container'); const btnC=document.getElementById('load-more-shorts-container'); if(reset){ host.innerHTML=''; shortsPageToken=null; } try{ let url='/.netlify/functions/shorts?q='+encodeURIComponent("islamic kids"); if(shortsPageToken) url+='&pageToken='+encodeURIComponent(shortsPageToken); const data=await fetchJSON(url); const items=(data.items||[]).filter(it=>it.id&&it.id.videoId); if(reset && !items.length){ host.innerHTML='<div class="title" style="color:#a00">No shorts found.</div>'; return; } for(const it of items){ const v=it.id.videoId, t=it.snippet.title, th=(it.snippet.thumbnails&&(it.snippet.thumbnails.high||it.snippet.thumbnails.medium||it.snippet.thumbnails.default)).url; host.insertAdjacentHTML('beforeend', cardHTML(v,t,th)); } shortsPageToken=data.nextPageToken||null; btnC.innerHTML = shortsPageToken ? '<button class="btn" id="moreShortsBtn">Load More Shorts</button>' : ''; document.getElementById('moreShortsBtn')?.addEventListener('click', ()=>loadDeenShorts(false)); }catch(e){ if(reset) host.innerHTML='<div class="title" style="color:#a00">Error loading DeenShorts.</div>'; console.error(e); } }
document.getElementById('searchBtn')?.addEventListener('click', ()=>{ const q=(document.getElementById('search').value||'').trim(); if(q){ currentQuery=q; loadHomeVideos(true); } });
document.addEventListener('DOMContentLoaded', ()=>{ loadHomeVideos(true); loadDeenShorts(true); });
